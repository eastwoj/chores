<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Daily Review</h1>
      <p class="text-gray-600 mt-2">Review and approve today's completed chores and extras</p>
    </div>
    <%= link_to "← Back to Dashboard", admin_dashboard_index_path, class: "bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors" %>
  </div>

  <!-- Date Navigation -->
  <div class="mb-6 flex justify-center">
    <div class="flex items-center space-x-4">
      <!-- Previous Week -->
      <%= link_to admin_reviews_path(date: @date - 1.week, child_id: params[:child_id]), 
                  class: "bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg font-medium transition-colors flex items-center" do %>
        <span class="mr-1">« Week</span>
      <% end %>
      
      <!-- Previous Day -->
      <%= link_to admin_reviews_path(date: @date - 1.day, child_id: params[:child_id]), 
                  class: "bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg font-medium transition-colors flex items-center" do %>
        <span class="mr-1">‹ Day</span>
      <% end %>
      
      <!-- Current Date Display -->
      <div class="bg-blue-50 text-blue-800 px-4 py-2 rounded-lg font-semibold text-center min-w-[200px]">
        <%= @date.strftime("%A, %B %d, %Y") %>
      </div>
      
      <!-- Next Day -->
      <%= link_to admin_reviews_path(date: @date + 1.day, child_id: params[:child_id]), 
                  class: "bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg font-medium transition-colors flex items-center" do %>
        <span class="ml-1">Day ›</span>
      <% end %>
      
      <!-- Next Week -->
      <%= link_to admin_reviews_path(date: @date + 1.week, child_id: params[:child_id]), 
                  class: "bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg font-medium transition-colors flex items-center" do %>
        <span class="ml-1">Week »</span>
      <% end %>
    </div>
  </div>

  <!-- Date Selector and Filters -->
  <div class="mb-6">
    <div class="flex items-center space-x-4">
      <%= form_with url: admin_reviews_path, method: :get, local: true, class: "flex items-center space-x-4" do |form| %>
        <div class="flex items-center space-x-2">
          <label class="font-medium text-gray-700">Review Date:</label>
          <%= form.date_field :date, value: @date, class: "border border-gray-300 rounded-lg px-3 py-2" %>
        </div>
        <div class="flex items-center space-x-2">
          <label class="font-medium text-gray-700">Child:</label>
          <%= form.select :child_id, options_for_select([["All Children", ""]] + @family.children.active.map { |child| [child.name, child.id] }, params[:child_id]), {}, { class: "border border-gray-300 rounded-lg px-3 py-2" } %>
        </div>
        <%= form.submit "Load", class: "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors" %>
      <% end %>
    </div>
  </div>

  <!-- Today's Items Section -->
  <% if @pending_chore_completions.any? || @pending_extra_completions.any? %>
    <div class="mb-12">
      <div class="flex items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Today's Items</h2>
        <span class="ml-3 bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
          <%= @pending_chore_completions.count + @pending_extra_completions.count %> items
        </span>
      </div>

      <!-- All Chores -->
      <% if @pending_chore_completions.any? %>
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Regular Chores</h3>
          <div class="space-y-4">
            <% @pending_chore_completions.each do |completion| %>
              <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <div class="flex items-center mb-2">
                      <h4 class="text-lg font-semibold text-gray-900 mr-3"><%= completion.chore.name %></h4>
                      <span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded-full mr-2">
                        <%= completion.child.name %>
                      </span>
                      <% case completion.status %>
                      <% when "pending" %>
                        <span class="bg-gray-100 text-gray-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                          Not Started
                        </span>
                      <% when "completed" %>
                        <span class="bg-orange-100 text-orange-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                          Marked Complete
                        </span>
                      <% when "reviewed_satisfactory" %>
                        <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                          Approved
                        </span>
                      <% when "reviewed_unsatisfactory" %>
                        <span class="bg-red-100 text-red-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                          Needs Redo
                        </span>
                      <% end %>
                    </div>
                    <% if completion.completed_at %>
                      <p class="text-gray-600 text-sm mb-2">
                        Completed: <%= completion.completed_at.strftime("%l:%M %p") %>
                      </p>
                    <% else %>
                      <p class="text-gray-600 text-sm mb-2">
                        Assigned: <%= completion.assigned_date.strftime("%B %d, %Y") %>
                      </p>
                    <% end %>
                    <% if completion.chore.description.present? %>
                      <p class="text-gray-500 text-sm"><%= completion.chore.description %></p>
                    <% end %>
                  </div>
                  <% if completion.completed? %>
                    <div class="flex space-x-2 ml-4">
                      <!-- Quick Actions -->
                      <%= form_with url: approve_chore_admin_review_path(completion), method: :patch, local: true, class: "inline" do |f| %>
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                          ✓ Approve
                        </button>
                      <% end %>
                      
                      <!-- Reject with Modal -->
                      <button onclick="openRejectModal('chore', <%= completion.id %>, '<%= completion.chore.name %>', '<%= completion.child.name %>')"
                              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                        ✗ Reject
                      </button>
                      
                      <!-- Reset with Modal -->
                      <button onclick="openResetModal('chore', <%= completion.id %>, '<%= completion.chore.name %>', '<%= completion.child.name %>')"
                              class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                        ↻ Reset
                      </button>
                    </div>
                  <% else %>
                    <div class="flex items-center ml-4">
                      <span class="text-gray-500 text-sm italic">Waiting for child to complete</span>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Pending Extras -->
      <% if @pending_extra_completions.any? %>
        <div class="mb-8">
          <h3 class="text-xl font-semibold text-gray-800 mb-4">Extra Tasks</h3>
          <div class="space-y-4">
            <% @pending_extra_completions.each do |completion| %>
              <div class="bg-green-50 border border-green-200 rounded-lg p-6 hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start">
                  <div class="flex-1">
                    <div class="flex items-center mb-2">
                      <h4 class="text-lg font-semibold text-gray-900 mr-3"><%= completion.extra.title %></h4>
                      <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded-full mr-2">
                        <%= completion.child.name %>
                      </span>
                      <% case completion.status %>
                      <% when "pending" %>
                        <span class="bg-gray-100 text-gray-800 text-sm font-medium px-2.5 py-0.5 rounded-full mr-2">
                          Not Started
                        </span>
                      <% when "completed" %>
                        <span class="bg-orange-100 text-orange-800 text-sm font-medium px-2.5 py-0.5 rounded-full mr-2">
                          Marked Complete
                        </span>
                      <% when "approved" %>
                        <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded-full mr-2">
                          Approved
                        </span>
                      <% when "rejected" %>
                        <span class="bg-red-100 text-red-800 text-sm font-medium px-2.5 py-0.5 rounded-full mr-2">
                          Rejected
                        </span>
                      <% end %>
                      <span class="bg-yellow-100 text-yellow-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                        $<%= sprintf("%.2f", completion.earned_amount) %>
                      </span>
                    </div>
                    <p class="text-gray-600 text-sm mb-2">
                      Completed: <%= completion.completed_at.strftime("%l:%M %p") %>
                    </p>
                    <% if completion.extra.description.present? %>
                      <p class="text-gray-500 text-sm"><%= completion.extra.description %></p>
                    <% end %>
                  </div>
                  <div class="flex space-x-2 ml-4">
                    <%= form_with url: approve_extra_admin_review_path(completion), method: :patch, local: true, class: "inline" do |f| %>
                      <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                        ✓ Approve
                      </button>
                    <% end %>
                    
                    <button onclick="openRejectModal('extra', <%= completion.id %>, '<%= completion.extra.title %>', '<%= completion.child.name %>')"
                            class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">
                      ✗ Reject
                    </button>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-12 mb-12">
      <div class="text-6xl mb-4">✨</div>
      <h2 class="text-2xl font-bold text-gray-900 mb-2">All caught up!</h2>
      <p class="text-gray-600">No pending chores or extras need review for <%= @date.strftime("%B %d, %Y") %>.</p>
    </div>
  <% end %>

  <!-- Reviewed Items Section -->
  <% if @reviewed_chore_completions.any? || @reviewed_extra_completions.any? %>
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">Already Reviewed Today</h2>

      <% if @reviewed_chore_completions.any? %>
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Chores</h3>
          <div class="space-y-2">
            <% @reviewed_chore_completions.each do |completion| %>
              <div class="flex items-center justify-between bg-gray-50 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                  <% if completion.reviewed_satisfactory? %>
                    <span class="text-green-600">✓</span>
                  <% else %>
                    <span class="text-red-600">✗</span>
                  <% end %>
                  <span class="font-medium"><%= completion.chore.name %></span>
                  <span class="text-gray-600">by <%= completion.child.name %></span>
                  <% case completion.status %>
                  <% when "reviewed_satisfactory" %>
                    <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                      Approved
                    </span>
                  <% when "reviewed_unsatisfactory" %>
                    <span class="bg-red-100 text-red-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                      Needs Redo
                    </span>
                  <% end %>
                  <% if completion.review_notes.present? %>
                    <span class="text-gray-500 text-sm">• <%= completion.review_notes %></span>
                  <% end %>
                </div>
                <span class="text-gray-500 text-sm">
                  <%= completion.reviewed_at.strftime("%l:%M %p") %>
                </span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @reviewed_extra_completions.any? %>
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Extras</h3>
          <div class="space-y-2">
            <% @reviewed_extra_completions.each do |completion| %>
              <div class="flex items-center justify-between bg-gray-50 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                  <% if completion.approved? %>
                    <span class="text-green-600">✓</span>
                  <% else %>
                    <span class="text-red-600">✗</span>
                  <% end %>
                  <span class="font-medium"><%= completion.extra.title %></span>
                  <span class="text-gray-600">by <%= completion.child.name %></span>
                  <% case completion.status %>
                  <% when "approved" %>
                    <span class="bg-green-100 text-green-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                      Approved
                    </span>
                  <% when "rejected" %>
                    <span class="bg-red-100 text-red-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                      Rejected
                    </span>
                  <% end %>
                  <% if completion.approved? %>
                    <span class="text-green-600 font-medium">$<%= sprintf("%.2f", completion.earned_amount) %></span>
                  <% end %>
                  <% if completion.notes.present? %>
                    <span class="text-gray-500 text-sm">• <%= completion.notes %></span>
                  <% end %>
                </div>
                <span class="text-gray-500 text-sm">
                  <%= completion.approved_at.strftime("%l:%M %p") %>
                </span>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-md mx-4">
    <h3 class="text-lg font-bold text-gray-900 mb-4">Reject <span id="rejectItemType"></span></h3>
    <p class="text-gray-600 mb-4">
      Rejecting "<span id="rejectItemName"></span>" for <span id="rejectChildName"></span>.
      You can add a note to explain what needs to be improved.
    </p>
    
    <form id="rejectForm" method="post">
      <input type="hidden" name="_method" value="patch">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Note to child (optional):</label>
        <textarea name="review_notes" id="rejectNotes" rows="3" 
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent"
                  placeholder="e.g., Please clean under the bed too, or You forgot to wipe the sink"></textarea>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeRejectModal()" 
                class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
          Cancel
        </button>
        <button type="submit" 
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          Reject
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Reset Modal -->
<div id="resetModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-6 max-w-md mx-4">
    <h3 class="text-lg font-bold text-gray-900 mb-4">Reset Chore</h3>
    <p class="text-gray-600 mb-4">
      Resetting "<span id="resetItemName"></span>" for <span id="resetChildName"></span> back to "not started".
      They'll need to redo this chore completely.
    </p>
    
    <form id="resetForm" method="post">
      <input type="hidden" name="_method" value="patch">
      <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
      
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Note to child:</label>
        <textarea name="review_notes" id="resetNotes" rows="3" 
                  class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                  placeholder="e.g., Please do this chore more carefully, or I can see you rushed through this">Please redo this chore</textarea>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeResetModal()" 
                class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
          Cancel
        </button>
        <button type="submit" 
                class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
          Reset
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function openRejectModal(itemType, itemId, itemName, childName) {
  document.getElementById('rejectItemType').textContent = itemType;
  document.getElementById('rejectItemName').textContent = itemName;
  document.getElementById('rejectChildName').textContent = childName;
  
  const form = document.getElementById('rejectForm');
  if (itemType === 'chore') {
    form.action = `/admin/reviews/${itemId}/reject_chore`;
    document.getElementById('rejectNotes').name = 'review_notes';
  } else {
    form.action = `/admin/reviews/${itemId}/reject_extra`;
    document.getElementById('rejectNotes').name = 'notes';
  }
  
  document.getElementById('rejectModal').classList.remove('hidden');
}

function closeRejectModal() {
  document.getElementById('rejectModal').classList.add('hidden');
  document.getElementById('rejectNotes').value = '';
}

function openResetModal(itemType, itemId, itemName, childName) {
  document.getElementById('resetItemName').textContent = itemName;
  document.getElementById('resetChildName').textContent = childName;
  
  const form = document.getElementById('resetForm');
  form.action = `/admin/reviews/${itemId}/reset_chore`;
  
  document.getElementById('resetModal').classList.remove('hidden');
}

function closeResetModal() {
  document.getElementById('resetModal').classList.add('hidden');
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
  if (e.target.id === 'rejectModal') {
    closeRejectModal();
  }
  if (e.target.id === 'resetModal') {
    closeResetModal();
  }
});
</script>